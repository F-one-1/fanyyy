<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Anthony Fu"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><link rel="alternate" type="application/rss+xml" title="Anthony Fu's Blog" href="/feed.xml"><meta name="msapplication-TileColor" content="#ffffff"><title>Async with Composition API</title><script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app.eba6dd3d.js"></script><style>*,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji"}body{margin:0;line-height:inherit}h1,h2,h3,h4{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}strong{font-weight:bolder}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:1em}h1,h2,h3,h4,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}:root{--c-bg:#fff;--c-scrollbar:#eee;--c-scrollbar-hover:#bbb}html{background-color:var(--c-bg)}html{overflow:scroll}*{scrollbar-color:var(--c-scrollbar) var(--c-bg)}.prose{color:var(--fg);max-width:65ch;font-size:1rem;line-height:1.75}.prose a{color:var(--fg-deeper);text-decoration:none;font-weight:500}.prose strong{color:var(--fg-deep);font-weight:600}.prose ul>li{position:relative;padding-left:1.75em}.prose ul>li:before{content:"";position:absolute;background-color:#d1d5db;border-radius:50%;width:.375em;height:.375em;top:.6875em;left:.25em}.prose h1{color:var(--fg-deeper);font-weight:800;font-size:2.25em;margin-top:0;margin-bottom:.8888889em;line-height:1.1111111}.prose h2{color:var(--fg-deep);font-weight:700;font-size:1.5em;margin-top:2em;margin-bottom:1em;line-height:1.3333333}.prose h3{color:inherit;font-weight:600;font-size:1.25em;margin-top:1.6em;margin-bottom:.6em;line-height:1.6;opacity:.7}.prose h4{color:inherit;font-weight:600;margin-top:1.5em;margin-bottom:.5em;line-height:1.5}.prose code{color:var(--fg-deep);font-weight:600;font-size:.875em}.prose code:before{content:"`"}.prose code:after{content:"`"}.prose a code{color:#111827}.prose pre{color:#e5e7eb;overflow-x:auto;font-size:.875em;line-height:1.7142857;margin-top:1.7142857em;margin-bottom:1.7142857em;border-radius:.375rem;padding:.8571429em 1.1428571em}.prose pre code{background-color:transparent;border-width:0;border-radius:0;padding:0;font-weight:400;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit}.prose pre code:before{content:none}.prose pre code:after{content:none}.prose p{margin-top:1.25em;margin-bottom:1.25em}.prose ul{margin-top:1.25em;margin-bottom:1.25em;list-style-type:none}.prose li{margin-top:.5em;margin-bottom:.5em}.prose h2+*{margin-top:0}.prose h3+*{margin-top:0}.prose h4+*{margin-top:0}.prose>:first-child{margin-top:0}.prose>:last-child{margin-bottom:0}.prose pre:not(.shiki){padding:0;margin:0;background:0 0}.prose .shiki{font-family:DM Mono,Input Mono,Fira Code,monospace;font-size:1.05em;line-height:1.4;margin:.5em 0}.shiki-light{background:#f8f8f8!important}.shiki-dark{background:#0e0e0e!important}html:not(.dark) .shiki-dark{display:none}.prose{--fg:#555;--fg-deep:#222;--fg-deeper:#000;color:var(--fg)}.prose a{font-weight:inherit;text-decoration:none;border-bottom:1px solid rgba(125,125,125,.3);transition:border .3s ease-in-out}.prose a:hover{border-bottom:1px solid var(--fg)}.prose a code{color:inherit}a.header-anchor{float:left;margin-top:.125em;margin-left:-1.2em;padding-right:.5em;font-size:.85em;opacity:0;text-decoration:none;border:0!important}a.header-anchor:focus,a.header-anchor:hover{text-decoration:none}h2:focus .header-anchor,h2:hover .header-anchor,h3:focus .header-anchor,h3:hover .header-anchor,h4:focus .header-anchor,h4:hover .header-anchor{opacity:.5}*,::after,::before{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-scroll-snap-strictness:proximity;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgba(0,0,0,0);--un-ring-shadow:0 0 rgba(0,0,0,0);--un-shadow:0 0 rgba(0,0,0,0);--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgba(147,197,253,0.5)}[i-la-rss-square=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 32 32' display='inline-block' height='1.2em' width='1.2em' vertical-align='text-bottom' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M5 5v22h22V5zm2 2h18v18H7zm5 3a9.91 9.91 0 0 0-2 .188v2.062a7.86 7.86 0 0 1 2-.25c4.41 0 8 3.59 8 8a8.04 8.04 0 0 1-.25 2h2.063A9.923 9.923 0 0 0 22 20c0-5.516-4.484-10-10-10zm0 4a5.96 5.96 0 0 0-2 .344v2.219A3.968 3.968 0 0 1 12 16c2.207 0 4 1.793 4 4c0 .73-.219 1.41-.563 2h2.22A5.96 5.96 0 0 0 18 20c0-3.309-2.691-6-6-6zm0 4a1.999 1.999 0 1 0 0 4a1.999 1.999 0 1 0 0-4z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;height:1.2em;width:1.2em;vertical-align:text-bottom}[i-ri-article-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' display='inline-block' height='1.2em' width='1.2em' vertical-align='text-bottom' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M20 22H4a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1zm-1-2V4H5v16h14zM7 6h4v4H7V6zm0 6h10v2H7v-2zm0 4h10v2H7v-2zm6-9h4v2h-4V7z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;height:1.2em;width:1.2em;vertical-align:text-bottom}[i-ri-heart-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' display='inline-block' height='1.2em' width='1.2em' vertical-align='text-bottom' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M12.001 4.529a5.998 5.998 0 0 1 8.242.228a6 6 0 0 1 .236 8.236l-8.48 8.492l-8.478-8.492a6 6 0 0 1 8.48-8.464zm6.826 1.641a3.998 3.998 0 0 0-5.49-.153l-1.335 1.198l-1.336-1.197a3.999 3.999 0 0 0-5.494.154a4 4 0 0 0-.192 5.451L12 18.654l7.02-7.03a4 4 0 0 0-.193-5.454z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;height:1.2em;width:1.2em;vertical-align:text-bottom}[i-ri-lightbulb-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' display='inline-block' height='1.2em' width='1.2em' vertical-align='text-bottom' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M9.973 18H11v-5h2v5h1.027c.132-1.202.745-2.194 1.74-3.277c.113-.122.832-.867.917-.973a6 6 0 1 0-9.37-.002c.086.107.807.853.918.974c.996 1.084 1.609 2.076 1.741 3.278zM10 20v1h4v-1h-4zm-4.246-5a8 8 0 1 1 12.49.002C17.624 15.774 16 17 16 18.5V21a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-2.5C8 17 6.375 15.774 5.754 15z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;height:1.2em;width:1.2em;vertical-align:text-bottom}[i-ri-screenshot-line=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' display='inline-block' height='1.2em' width='1.2em' vertical-align='text-bottom' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='m11.993 14.407l-1.552 1.552a4 4 0 1 1-1.418-1.41l1.555-1.556l-4.185-4.185l1.415-1.415l4.185 4.185l4.189-4.189l1.414 1.414l-4.19 4.19l1.562 1.56a4 4 0 1 1-1.414 1.414l-1.561-1.56zM7 20a2 2 0 1 0 0-4a2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4a2 2 0 0 0 0 4zm2-7V5H5v8H3V4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v9h-2z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;height:1.2em;width:1.2em;vertical-align:text-bottom}[i-uil-github-alt=""]{--un-icon:url("data:image/svg+xml;utf8,%3Csvg viewBox='0 0 24 24' display='inline-block' height='1.2em' width='1.2em' vertical-align='text-bottom' xmlns='http://www.w3.org/2000/svg' %3E%3Cpath fill='currentColor' d='M10.07 20.503a1 1 0 0 0-1.18-.983c-1.31.24-2.963.276-3.402-.958a5.708 5.708 0 0 0-1.837-2.415a1.2 1.2 0 0 1-.167-.11a1 1 0 0 0-.93-.645h-.005a1 1 0 0 0-1 .995c-.004.815.81 1.338 1.141 1.514a4.44 4.44 0 0 1 .924 1.36c.365 1.023 1.423 2.576 4.466 2.376l.003.098l.004.268a1 1 0 0 0 2 0l-.005-.318c-.005-.19-.012-.464-.012-1.182ZM20.737 5.377a5.39 5.39 0 0 0 .09-.42a6.278 6.278 0 0 0-.408-3.293a1.002 1.002 0 0 0-.615-.58c-.356-.12-1.67-.357-4.184 1.25a13.87 13.87 0 0 0-6.354 0C6.762.75 5.455.966 5.102 1.079a.997.997 0 0 0-.631.584a6.3 6.3 0 0 0-.404 3.357c.025.127.051.246.079.354a6.27 6.27 0 0 0-1.256 3.83a8.422 8.422 0 0 0 .043.921c.334 4.603 3.334 5.984 5.424 6.459a4.591 4.591 0 0 0-.118.4a1 1 0 0 0 1.942.479a1.678 1.678 0 0 1 .468-.878a1 1 0 0 0-.546-1.745c-3.454-.395-4.954-1.802-5.18-4.899a6.61 6.61 0 0 1-.033-.738a4.258 4.258 0 0 1 .92-2.713a3.022 3.022 0 0 1 .195-.231a1 1 0 0 0 .188-1.025a3.388 3.388 0 0 1-.155-.555a4.094 4.094 0 0 1 .079-1.616a7.543 7.543 0 0 1 2.415 1.18a1.009 1.009 0 0 0 .827.133a11.777 11.777 0 0 1 6.173.001a1.005 1.005 0 0 0 .83-.138a7.572 7.572 0 0 1 2.406-1.19a4.04 4.04 0 0 1 .087 1.578a3.205 3.205 0 0 1-.169.607a1 1 0 0 0 .188 1.025c.078.087.155.18.224.268A4.122 4.122 0 0 1 20 9.203a7.039 7.039 0 0 1-.038.777c-.22 3.056-1.725 4.464-5.195 4.86a1 1 0 0 0-.546 1.746a1.63 1.63 0 0 1 .466.908a3.06 3.06 0 0 1 .093.82v2.333c-.01.648-.01 1.133-.01 1.356a1 1 0 1 0 2 0c0-.217 0-.692.01-1.34v-2.35a4.881 4.881 0 0 0-.155-1.311a4.256 4.256 0 0 0-.116-.416a6.513 6.513 0 0 0 5.445-6.424A8.697 8.697 0 0 0 22 9.203a6.13 6.13 0 0 0-1.263-3.826Z'/%3E%3C/svg%3E");mask:var(--un-icon) no-repeat;mask-size:100% 100%;-webkit-mask:var(--un-icon) no-repeat;-webkit-mask-size:100% 100%;background-color:currentColor;display:inline-block;height:1.2em;width:1.2em;vertical-align:text-bottom}.absolute{position:absolute}.z-40{z-index:40}.grid{display:grid}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.m-6{margin:1.5rem}.m-auto{margin:auto}.\!-mt-2{margin-top:-.5rem!important}.mb-0{margin-bottom:0}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-10{margin-top:2.5rem}.mt-8{margin-top:2rem}.inline{display:inline}.h-10{height:2.5rem}.w-10{width:2.5rem}.flex{display:flex}.flex-auto{flex:1 1 auto}.select-none{user-select:none}.gap-2{grid-gap:.5rem;gap:.5rem}[fill~=none]{fill:none}.px-7{padding-left:1.75rem;padding-right:1.75rem}.py-10{padding-top:2.5rem;padding-bottom:2.5rem}.font-mono{font-family:"DM Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}.font-sans{font-family:Inter,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}.text-sm{font-size:.875rem;line-height:1.25rem}.text-gray-700{--un-text-opacity:1;color:rgba(55,65,81,var(--un-text-opacity))}.no-underline{text-decoration:none}.opacity-50,[op50=""]{opacity:.5}.hover\:opacity-75:hover{opacity:.75}.outline-none{outline:2px solid transparent;outline-offset:2px}@media (max-width:767.9px){.lt-md\:hidden{display:none}}@media (max-width:639.9px){.lt-sm\:grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}}@media (min-width:768px){.md\:hidden,[md\:hidden=""]{display:none}}@media (min-width:1024px){.lg\:fixed{position:fixed}}.nav[data-v-6169d58d]{padding:2rem;width:100%;display:grid;grid-template-columns:auto max-content;box-sizing:border-box}.nav>[data-v-6169d58d]{margin:auto}.nav a[data-v-6169d58d]{cursor:pointer;text-decoration:none;color:inherit;transition:opacity .2s ease;opacity:.6;outline:0}.nav a[data-v-6169d58d]:hover{opacity:1;text-decoration-color:inherit}.nav .right[data-v-6169d58d]{display:grid;grid-gap:1.2rem;grid-auto-flow:column}.nav .right>[data-v-6169d58d]{margin:auto}</style><link rel="preload" href="/assets/index.e1648c97.css" as="style"><link rel="modulepreload" crossorigin="" href="/assets/async-with-composition-api.133408a8.js"><meta property="og:image" content="https://antfu.me/og-icon.png"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@antfu7"><meta property="og:title" content="Async with Composition API"><meta property="og:description" content="Notes about the caveat when using async functions in Vue Composition API."><meta name="description" content="Notes about the caveat when using async functions in Vue Composition API."><meta name="head:count" content="6"><link rel="preload" as="font" crossorigin="anonymous" href="https://fonts.gstatic.com/s/dmmono/v10/aFTU7PB1QTsUX8KYhh0.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZg.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZg.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuDyYMZg.ttf"></head><body class="font-sans text-gray-700 dark:text-gray-200"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-6169d58d=""><a href="/" class="w-10 h-10 absolute lg:fixed m-6 select-none outline-none" focusable="false" data-v-6169d58d=""><img src="/logo-dark.svg" alt="logo" style="display:none" data-v-6169d58d=""><img src="/logo.svg" alt="logo" data-v-6169d58d=""></a><nav class="nav" data-v-6169d58d=""><div class="spacer" data-v-6169d58d=""></div><div class="right" data-v-6169d58d=""><a href="/posts" class="" title="Blog" data-v-6169d58d=""><span class="lt-md:hidden" data-v-6169d58d="">Blog</span><div i-ri-article-line="" md:hidden="" data-v-6169d58d=""></div></a><a href="/projects" class="" title="Projects" data-v-6169d58d=""><span class="lt-md:hidden" data-v-6169d58d="">Projects</span><div i-ri-lightbulb-line="" class="md:hidden" data-v-6169d58d=""></div></a><a href="/talks" class="lt-md:hidden" title="Talks" data-v-6169d58d="">Talks </a><a href="/podcasts" class="lt-md:hidden" title="Podcasts" data-v-6169d58d="">Podcasts </a><a href="/streams" class="lt-md:hidden" title="Streams" data-v-6169d58d="">Streams </a><a href="/demos" class="" title="Demos" data-v-6169d58d=""><span class="lt-md:hidden" data-v-6169d58d="">Demos</span><div i-ri-screenshot-line="" class="md:hidden" data-v-6169d58d=""></div></a><a href="/sponsors-list" class="" title="Sponsors" data-v-6169d58d=""><div i-ri-heart-line="" data-v-6169d58d=""></div></a><a href="https://twitter.com/antfu7" target="_blank" title="Twitter" class="lt-md:hidden" data-v-6169d58d=""><svg style="vertical-align:sub" class="inline" viewBox="0 0 24 24" width="1.2em" height="1.2em" data-v-6169d58d=""><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M23 3a10.9 10.9 0 0 1-3.14 1.53a4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/antfu" target="_blank" title="GitHub" class="lt-md:hidden" data-v-6169d58d=""><div i-uil-github-alt="" data-v-6169d58d=""></div></a><a href="/feed.xml" target="_blank" title="RSS" class="lt-md:hidden" data-v-6169d58d=""><div i-la-rss-square="" style="font-size:1.25rem;margin:0 -.125rem" data-v-6169d58d=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-6169d58d=""><svg style="vertical-align:sub;display:none" class="inline" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path fill="currentColor" d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938A7.999 7.999 0 0 0 4 12z"></path></svg><svg style="vertical-align:sub" class="inline" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path fill="currentColor" d="M12 18a6 6 0 1 1 0-12a6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636L5.636 7.05L3.515 4.93zM16.95 18.364l1.414-1.414l2.121 2.121l-1.414 1.414l-2.121-2.121zm2.121-14.85l1.414 1.415l-2.121 2.121l-1.414-1.414l2.121-2.121zM5.636 16.95l1.414 1.414l-2.121 2.121l-1.414-1.414l2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></a></div></nav></header><main class="px-7 py-10"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0">Async with Composition API</h1><p class="opacity-50 !-mt-2">Jul 16, 2021 <span>· 17min</span></p><!----></div><article><!--[--><div class="prose m-auto"><p>There is a major caveat when working with asynchronous functions in Vue Composition API, that I believe many of you have ever come across. I have acknowledged it for a while from somewhere, but every time I want to have a detailed reference and share to others, I can’t find it’s documented anywhere. So, I am thinking about writing one, with a detailed explanation while sorting out the possible solutions for you.</p><ul><li><a href="#the-problem">The Problem</a></li><li><a href="#the-mechanism">The Mechanism</a></li><li><a href="#the-limitation">The Limitation</a></li><li><a href="#the-solutions">The Solutions</a></li></ul><h2 id="the-problem" tabindex="-1">The Problem <a class="header-anchor" href="#the-problem" aria-hidden="true">#</a></h2><p>When using asynchronous <code>setup()</code>, <strong>you have to use effects and lifecycle hooks before the first <code>await</code> statement.</strong> (<a href="https://github.com/vuejs/rfcs/discussions/234" target="_blank" rel="noopener">details</a>)</p><p>For example:</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#4d9375">import</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">ref</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">watch</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">onMounted</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">onUnmounted</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">from</span><span style="color:#dbd7ca"> </span><span style="color:#c98a7d">'vue'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4d9375">export</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">default</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">defineAsyncComponent</span><span style="color:#858585">({</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">async</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">counter</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">ref</span><span style="color:#858585">(</span><span style="color:#6394bf">0</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#a1b567">watch</span><span style="color:#858585">(</span><span style="color:#b8a965">counter</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#b8a965">counter</span><span style="color:#858585">.</span><span style="color:#b8a965">value</span><span style="color:#858585">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// OK!</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#a1b567">onMounted</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#c98a7d">'Mounted'</span><span style="color:#858585">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// the await statement</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">someAsyncFunction</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#758575">// &lt;-----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// does NOT work!</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#a1b567">onUnmounted</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#c98a7d">'Unmounted'</span><span style="color:#858585">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// still works, but does not auto-dispose </span></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// after the component is destroyed (memory leak!)</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#a1b567">watch</span><span style="color:#858585">(</span><span style="color:#b8a965">counter</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#b8a965">counter</span><span style="color:#858585">.</span><span style="color:#b8a965">value</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">*</span><span style="color:#dbd7ca"> </span><span style="color:#6394bf">2</span><span style="color:#858585">))</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">}</span></span>
<span class="line"><span style="color:#858585">})</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#1c6b48">import</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">ref</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8c862b">watch</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8c862b">onMounted</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8c862b">onUnmounted</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#1c6b48">from</span><span style="color:#393a34"> </span><span style="color:#b56959">'vue'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1c6b48">export</span><span style="color:#393a34"> </span><span style="color:#1c6b48">default</span><span style="color:#393a34"> </span><span style="color:#6c7834">defineAsyncComponent</span><span style="color:#8e8f8b">({</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">async</span><span style="color:#393a34"> </span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">counter</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">ref</span><span style="color:#8e8f8b">(</span><span style="color:#296aa3">0</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#6c7834">watch</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">counter</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">counter</span><span style="color:#8e8f8b">.</span><span style="color:#8c862b">value</span><span style="color:#8e8f8b">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// OK!</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#6c7834">onMounted</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'Mounted'</span><span style="color:#8e8f8b">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// the await statement</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#6c7834">someAsyncFunction</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#a0ada0">// &lt;-----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// does NOT work!</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#6c7834">onUnmounted</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'Unmounted'</span><span style="color:#8e8f8b">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// still works, but does not auto-dispose </span></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// after the component is destroyed (memory leak!)</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#6c7834">watch</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">counter</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">counter</span><span style="color:#8e8f8b">.</span><span style="color:#8c862b">value</span><span style="color:#393a34"> </span><span style="color:#ab5959">*</span><span style="color:#393a34"> </span><span style="color:#296aa3">2</span><span style="color:#8e8f8b">))</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">}</span></span>
<span class="line"><span style="color:#8e8f8b">})</span></span>
<span class="line"></span></code></pre></div></code></pre><p>After the <code>await</code> statement,</p><p>the following functions will be <strong>limited</strong> (no auto-dispose):</p><ul><li><code>watch</code> / <code>watchEffect</code></li><li><code>computed</code></li><li><code>effect</code></li></ul><p>the following functions will <strong>not work</strong>:</p><ul><li><code>onMounted</code> / <code>onUnmounted</code> / <code>onXXX</code></li><li><code>provide</code> / <code>inject</code></li><li><code>getCurrentInstance</code></li><li>…</li></ul><h2 id="the-mechanism" tabindex="-1">The Mechanism <a class="header-anchor" href="#the-mechanism" aria-hidden="true">#</a></h2><p>Let’s take the <code>onMounted</code> API as an example. As we know, <code>onMounted</code> is a hook that registers a listener when the current component gets mounted. Notice that <code>onMounted</code> (along with other composition APIs) are <strong>global</strong>, for what I mean "global" is that it can be imported and called anywhere - there is <strong>no local context</strong> bound to it.</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#758575">// local: `onMounted` is a method of `component` that bound to it</span></span>
<span class="line"><span style="color:#b8a965">component</span><span style="color:#858585">.</span><span style="color:#a1b567">onMounted</span><span style="color:#858585">(</span><span style="color:#758575">/* ... */</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575">// global: `onMounted` can be called without context</span></span>
<span class="line"><span style="color:#a1b567">onMounted</span><span style="color:#858585">(</span><span style="color:#758575">/* ... */</span><span style="color:#858585">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#a0ada0">// local: `onMounted` is a method of `component` that bound to it</span></span>
<span class="line"><span style="color:#8c862b">component</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">onMounted</span><span style="color:#8e8f8b">(</span><span style="color:#a0ada0">/* ... */</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a0ada0">// global: `onMounted` can be called without context</span></span>
<span class="line"><span style="color:#6c7834">onMounted</span><span style="color:#8e8f8b">(</span><span style="color:#a0ada0">/* ... */</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span></code></pre></div></code></pre><p>So, how does <code>onMounted</code> know what component is being mounted?</p><p>Vue takes an interesting approach to solve this. It uses an internal variable to record the current component instance. There is a simplified code:</p><p>When Vue mounts a component, it stores the instance in a global variable. When hooks been called inside the setup function, it will use the global variable to get the current component instance.</p><pre><code class="language-js"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#cb7676">let</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575">// (pseudo code)</span></span>
<span class="line"><span style="color:#4d9375">export</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">function</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">mountComponent</span><span style="color:#858585">(</span><span style="color:#b8a965">component</span><span style="color:#858585">)</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">instance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">createComponent</span><span style="color:#858585">(</span><span style="color:#b8a965">component</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">  </span><span style="color:#758575">// hold the previous instance</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">prev</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">currentInstance</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">  </span><span style="color:#758575">// set the instance to global</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">instance</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">  </span><span style="color:#758575">// hooks called inside the `setup()` will have</span></span>
<span class="line"><span style="color:#858585">  </span><span style="color:#758575">// the `currentInstance` as the context</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#b8a965">component</span><span style="color:#858585">.</span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">  </span><span style="color:#758575">// restore the previous instance</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">prev</span><span style="color:#dbd7ca"> </span></span>
<span class="line"><span style="color:#858585">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#ab5959">let</span><span style="color:#393a34"> </span><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#a65e2b">null</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a0ada0">// (pseudo code)</span></span>
<span class="line"><span style="color:#1c6b48">export</span><span style="color:#393a34"> </span><span style="color:#ab5959">function</span><span style="color:#393a34"> </span><span style="color:#6c7834">mountComponent</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">component</span><span style="color:#8e8f8b">)</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">instance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">createComponent</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">component</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">  </span><span style="color:#a0ada0">// hold the previous instance</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">prev</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">currentInstance</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">  </span><span style="color:#a0ada0">// set the instance to global</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">instance</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">  </span><span style="color:#a0ada0">// hooks called inside the `setup()` will have</span></span>
<span class="line"><span style="color:#8e8f8b">  </span><span style="color:#a0ada0">// the `currentInstance` as the context</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8c862b">component</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">  </span><span style="color:#a0ada0">// restore the previous instance</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">prev</span><span style="color:#393a34"> </span></span>
<span class="line"><span style="color:#8e8f8b">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>A simplified <code>onMounted</code> implementation would be like:</p><pre><code class="language-js"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#758575">// (pseudo code)</span></span>
<span class="line"><span style="color:#4d9375">export</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">function</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">onMounted</span><span style="color:#858585">(</span><span style="color:#b8a965">fn</span><span style="color:#858585">)</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#4d9375">if</span><span style="color:#dbd7ca"> </span><span style="color:#858585">(</span><span style="color:#cb7676">!</span><span style="color:#b8a965">currentInstance</span><span style="color:#858585">)</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#a1b567">warn</span><span style="color:#858585">(</span><span style="color:#c98a7d">`"onMounted" can't be called outside of component setup()`</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#4d9375">return</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">  </span><span style="color:#758575">// bound listener to the current instance</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#b8a965">currentInstance</span><span style="color:#858585">.</span><span style="color:#a1b567">onMounted</span><span style="color:#858585">(</span><span style="color:#b8a965">fn</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#858585">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#a0ada0">// (pseudo code)</span></span>
<span class="line"><span style="color:#1c6b48">export</span><span style="color:#393a34"> </span><span style="color:#ab5959">function</span><span style="color:#393a34"> </span><span style="color:#6c7834">onMounted</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">fn</span><span style="color:#8e8f8b">)</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#1c6b48">if</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">(</span><span style="color:#ab5959">!</span><span style="color:#8c862b">currentInstance</span><span style="color:#8e8f8b">)</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#6c7834">warn</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">`"onMounted" can't be called outside of component setup()`</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#1c6b48">return</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">  </span><span style="color:#a0ada0">// bound listener to the current instance</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8c862b">currentInstance</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">onMounted</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">fn</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#8e8f8b">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>With this approach, as long as the <code>onMounted</code> is called inside the component <code>setup()</code>, it will be able to get the instance of the current component.</p><h2 id="the-limitation" tabindex="-1">The Limitation <a class="header-anchor" href="#the-limitation" aria-hidden="true">#</a></h2><p>So far so good, but what’s wrong with asynchronous functions?</p><p>The implementation would work based on the fact that JavaScript is <strong>single-threaded</strong>. Single thread makes sure the following statements will be executed right next to each other, which in other words, there is no one could accidentally modify the <code>currentInstance</code> at the same time (a.k.a. it’s <a href="https://stackoverflow.com/questions/52196678/what-are-atomic-operations-for-newbies" target="_blank" rel="noopener">atomic</a>).</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">instance</span></span>
<span class="line"><span style="color:#b8a965">component</span><span style="color:#858585">.</span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span></span>
<span class="line"><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">prev</span><span style="color:#dbd7ca"> </span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">instance</span></span>
<span class="line"><span style="color:#8c862b">component</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span></span>
<span class="line"><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">prev</span><span style="color:#393a34"> </span></span>
<span class="line"></span></code></pre></div></code></pre><p>The situation changes when the <code>setup()</code> is asynchronous. Whenever you <code>await</code> a promise, you can think the engine paused the works here and went to do another task. If we <code>await</code> the function, during the time period, multiple components creation will change the global variable unpredictably and end up with a mess.</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">instance</span></span>
<span class="line"><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">component</span><span style="color:#858585">.</span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#758575">// atomic lost</span></span>
<span class="line"><span style="color:#b8a965">currentInstance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">prev</span><span style="color:#dbd7ca"> </span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">instance</span></span>
<span class="line"><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#8c862b">component</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#a0ada0">// atomic lost</span></span>
<span class="line"><span style="color:#8c862b">currentInstance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">prev</span><span style="color:#393a34"> </span></span>
<span class="line"></span></code></pre></div></code></pre><p>If we don’t use <code>await</code> to check the instance, calling the <code>setup()</code> function will make it finish the tasks before the first <code>await</code> statement, and the rest will be executed whenever the <code>await</code> statement is resolved.</p><div class="grid grid-cols-2 gap-2 lt-sm:grid-cols-1"><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#cb7676">async</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">function</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#6394bf">1</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">someAsyncFunction</span><span style="color:#858585">()</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#6394bf">2</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#858585">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#6394bf">3</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#a1b567">setup</span><span style="color:#858585">()</span></span>
<span class="line"><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#6394bf">4</span><span style="color:#858585">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#ab5959">async</span><span style="color:#393a34"> </span><span style="color:#ab5959">function</span><span style="color:#393a34"> </span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#296aa3">1</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#6c7834">someAsyncFunction</span><span style="color:#8e8f8b">()</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#296aa3">2</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#8e8f8b">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#296aa3">3</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span></span>
<span class="line"><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#296aa3">4</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span></code></pre></div></code></pre><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#758575">// output:</span></span>
<span class="line"><span style="color:#6394bf">3</span></span>
<span class="line"><span style="color:#6394bf">1</span></span>
<span class="line"><span style="color:#6394bf">4</span></span>
<span class="line"><span style="color:#858585">(</span><span style="color:#b8a965">awaiting</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#6394bf">2</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#a0ada0">// output:</span></span>
<span class="line"><span style="color:#296aa3">3</span></span>
<span class="line"><span style="color:#296aa3">1</span></span>
<span class="line"><span style="color:#296aa3">4</span></span>
<span class="line"><span style="color:#8e8f8b">(</span><span style="color:#8c862b">awaiting</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#296aa3">2</span></span>
<span class="line"></span></code></pre></div></code></pre></div><p>This means, there is no way for Vue to know when will the asynchronous part been called from the outside, so there is also no way to bound the instance to the context.</p><h2 id="the-solutions" tabindex="-1">The Solutions <a class="header-anchor" href="#the-solutions" aria-hidden="true">#</a></h2><p>This is actually a limitation of JavaScript itself, unless we have some new proposal to open the gate on the language level, we have to live with it.</p><p>But to work around it, I have collected a few solutions for you to choose from based on your needs.</p><h3 id="remember-the-caveat-and-avoid-it" tabindex="-1">Remember the Caveat and Avoid It <a class="header-anchor" href="#remember-the-caveat-and-avoid-it" aria-hidden="true">#</a></h3><p>This is, of course, an obvious "solution". You can try to move your effect and hooks before the first <code>await</code> statement and carefully remember not to have them after that again.</p><p>Luckily, if you are using ESLint, you can have the <a href="https://eslint.vuejs.org/rules/no-watch-after-await.html" target="_blank" rel="noopener"><code>vue/no-watch-after-await</code></a> and <a href="https://eslint.vuejs.org/rules/no-lifecycle-after-await.html" target="_blank" rel="noopener"><code>vue/no-lifecycle-after-await</code></a> rules from <a href="https://eslint.vuejs.org/" target="_blank" rel="noopener"><code>eslint-plugin-vue</code></a> enabled so it could warn you whenever you made some mistakes (they are enabled by default within the plugin presets).</p><h3 id="wrap-the-async-function-as-reactive-sync" tabindex="-1">Wrap the Async Function as "Reactive Sync" <a class="header-anchor" href="#wrap-the-async-function-as-reactive-sync" aria-hidden="true">#</a></h3><p>In some situations, your logic might be relying on the data that fetched asynchronously. In this way, you could consider using the <a href="/posts/composable-vue-vueday-2021#async-to-sync">trick I have shared on VueDay 2021</a> to <strong>turn your async function into a sync reactive state</strong>.</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">data</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">fetch</span><span style="color:#858585">(</span><span style="color:#c98a7d">'https://api.github.com/'</span><span style="color:#858585">).</span><span style="color:#a1b567">then</span><span style="color:#858585">(</span><span style="color:#b8a965">r</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">r</span><span style="color:#858585">.</span><span style="color:#a1b567">json</span><span style="color:#858585">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">user</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">data</span><span style="color:#858585">.</span><span style="color:#b8a965">user</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">data</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#6c7834">fetch</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'https://api.github.com/'</span><span style="color:#8e8f8b">).</span><span style="color:#6c7834">then</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">r</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">r</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">json</span><span style="color:#8e8f8b">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">user</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">data</span><span style="color:#8e8f8b">.</span><span style="color:#8c862b">user</span></span>
<span class="line"></span></code></pre></div></code></pre><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">data</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">ref</span><span style="color:#858585">(</span><span style="color:#d4976c">null</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a1b567">fetch</span><span style="color:#858585">(</span><span style="color:#c98a7d">'https://api.github.com/'</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">.</span><span style="color:#a1b567">then</span><span style="color:#858585">(</span><span style="color:#b8a965">r</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">r</span><span style="color:#858585">.</span><span style="color:#a1b567">json</span><span style="color:#858585">())</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">.</span><span style="color:#a1b567">then</span><span style="color:#858585">(</span><span style="color:#b8a965">res</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">data</span><span style="color:#858585">.</span><span style="color:#b8a965">value</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">res</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">user</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">computed</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">data</span><span style="color:#858585">?.</span><span style="color:#b8a965">user</span><span style="color:#858585">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">data</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">ref</span><span style="color:#8e8f8b">(</span><span style="color:#a65e2b">null</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6c7834">fetch</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'https://api.github.com/'</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">then</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">r</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">r</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">json</span><span style="color:#8e8f8b">())</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">then</span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">res</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">data</span><span style="color:#8e8f8b">.</span><span style="color:#8c862b">value</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#8c862b">res</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">user</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">computed</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">data</span><span style="color:#8e8f8b">?.</span><span style="color:#8c862b">user</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span></code></pre></div></code></pre><p>This approach make the "connections" between your logic to resolve first, and then reactive updates when the asynchronous function get resolved and filled with data.</p><p>There is also some more general utilities for it from <a href="https://vueuse.org/" target="_blank" rel="noopener">VueUse</a>:</p><h4 id="useasyncstate" tabindex="-1"><a href="https://vueuse.org/useAsyncState" target="_blank" rel="noopener"><code>useAsyncState</code></a> <a class="header-anchor" href="#useasyncstate" aria-hidden="true">#</a></h4><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#4d9375">import</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">useAsyncState</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">from</span><span style="color:#dbd7ca"> </span><span style="color:#c98a7d">'@vueuse/core'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">state</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">ready</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">useAsyncState</span><span style="color:#858585">(</span><span style="color:#cb7676">async</span><span style="color:#dbd7ca"> </span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">data</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">axios</span><span style="color:#858585">.</span><span style="color:#a1b567">get</span><span style="color:#858585">(</span><span style="color:#c98a7d">'https://api.github.com/'</span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#4d9375">return</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">data</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span></span>
<span class="line"><span style="color:#858585">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">user</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">computed</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">state</span><span style="color:#858585">?.</span><span style="color:#b8a965">user</span><span style="color:#858585">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#1c6b48">import</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">useAsyncState</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#1c6b48">from</span><span style="color:#393a34"> </span><span style="color:#b56959">'@vueuse/core'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#a65e2b">state</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#a65e2b">ready</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">useAsyncState</span><span style="color:#8e8f8b">(</span><span style="color:#ab5959">async</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#a65e2b">data</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#8c862b">axios</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">get</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'https://api.github.com/'</span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#1c6b48">return</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">data</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span></span>
<span class="line"><span style="color:#8e8f8b">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">user</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">computed</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">state</span><span style="color:#8e8f8b">?.</span><span style="color:#8c862b">user</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span></code></pre></div></code></pre><h4 id="usefetch" tabindex="-1"><a href="https://vueuse.org/useFetch" target="_blank" rel="noopener"><code>useFetch</code></a> <a class="header-anchor" href="#usefetch" aria-hidden="true">#</a></h4><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#4d9375">import</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">useFetch</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">from</span><span style="color:#dbd7ca"> </span><span style="color:#c98a7d">'@vueuse/core'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">data</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">isFetching</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">error</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">useFetch</span><span style="color:#858585">(</span><span style="color:#c98a7d">'https://api.github.com/'</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">user</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">computed</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">data</span><span style="color:#858585">?.</span><span style="color:#b8a965">user</span><span style="color:#858585">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#1c6b48">import</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">useFetch</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#1c6b48">from</span><span style="color:#393a34"> </span><span style="color:#b56959">'@vueuse/core'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#a65e2b">data</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#a65e2b">isFetching</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#a65e2b">error</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">useFetch</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'https://api.github.com/'</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">user</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">computed</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">data</span><span style="color:#8e8f8b">?.</span><span style="color:#8c862b">user</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span></code></pre></div></code></pre><h3 id="explicitly-bound-the-instance" tabindex="-1">Explicitly Bound the Instance <a class="header-anchor" href="#explicitly-bound-the-instance" aria-hidden="true">#</a></h3><p>Lifecycle hooks actually accept a second argument for setting the instance explicitly.</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#4d9375">export</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">default</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">defineAsyncComponent</span><span style="color:#858585">({</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">async</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// get and hold the instance before `await`</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">instance</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">getCurrentInstance</span><span style="color:#858585">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">someAsyncFunction</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#758575">// &lt;-----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#a1b567">onUnmounted</span><span style="color:#858585">(</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">console</span><span style="color:#858585">.</span><span style="color:#a1b567">log</span><span style="color:#858585">(</span><span style="color:#c98a7d">'Unmounted'</span><span style="color:#858585">),</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#b8a965">instance</span><span style="color:#dbd7ca"> </span><span style="color:#758575">// &lt;--- pass the instance to it</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#858585">)</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">}</span></span>
<span class="line"><span style="color:#858585">})</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#1c6b48">export</span><span style="color:#393a34"> </span><span style="color:#1c6b48">default</span><span style="color:#393a34"> </span><span style="color:#6c7834">defineAsyncComponent</span><span style="color:#8e8f8b">({</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">async</span><span style="color:#393a34"> </span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// get and hold the instance before `await`</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">instance</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">getCurrentInstance</span><span style="color:#8e8f8b">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#6c7834">someAsyncFunction</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#a0ada0">// &lt;-----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#6c7834">onUnmounted</span><span style="color:#8e8f8b">(</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">console</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">log</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">'Unmounted'</span><span style="color:#8e8f8b">),</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#8c862b">instance</span><span style="color:#393a34"> </span><span style="color:#a0ada0">// &lt;--- pass the instance to it</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#8e8f8b">)</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">}</span></span>
<span class="line"><span style="color:#8e8f8b">})</span></span>
<span class="line"></span></code></pre></div></code></pre><p>However, the downside is that this solution <strong>does not work</strong> with <code>watch</code> / <code>watchEffect</code> / <code>computed</code> / <code>provide</code> / <code>inject</code> as they does not accept the instance argument.</p><p>To get the effects work, you could use the <a href="https://github.com/vuejs/rfcs/blob/master/active-rfcs/0041-reactivity-effect-scope.md" target="_blank" rel="noopener"><code>effectScope</code> API</a> in the upcoming Vue 3.2.</p><pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#4d9375">import</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">effectScope</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">from</span><span style="color:#dbd7ca"> </span><span style="color:#c98a7d">'vue'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4d9375">export</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">default</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">defineAsyncComponent</span><span style="color:#858585">({</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">async</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// create the scope before `await`, so it will be bond to the instance</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">scope</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">effectScope</span><span style="color:#858585">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">data</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">someAsyncFunction</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#758575">// &lt;-----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#b8a965">scope</span><span style="color:#858585">.</span><span style="color:#a1b567">run</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#758575">/* Use `computed`, `watch`, etc. ... */</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#858585">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// the lifecycle hooks will not be available here,</span></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// you will need to combine it with the previous snippet</span></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// to have both lifecycle hooks and effects works.</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">}</span></span>
<span class="line"><span style="color:#858585">})</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#1c6b48">import</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">effectScope</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#1c6b48">from</span><span style="color:#393a34"> </span><span style="color:#b56959">'vue'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1c6b48">export</span><span style="color:#393a34"> </span><span style="color:#1c6b48">default</span><span style="color:#393a34"> </span><span style="color:#6c7834">defineAsyncComponent</span><span style="color:#8e8f8b">({</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">async</span><span style="color:#393a34"> </span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// create the scope before `await`, so it will be bond to the instance</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">scope</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">effectScope</span><span style="color:#8e8f8b">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">data</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#6c7834">someAsyncFunction</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#a0ada0">// &lt;-----------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#8c862b">scope</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">run</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#a0ada0">/* Use `computed`, `watch`, etc. ... */</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#8e8f8b">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// the lifecycle hooks will not be available here,</span></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// you will need to combine it with the previous snippet</span></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// to have both lifecycle hooks and effects works.</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">}</span></span>
<span class="line"><span style="color:#8e8f8b">})</span></span>
<span class="line"></span></code></pre></div></code></pre><h3 id="compile-time-magic" tabindex="-1">Compile-time Magic! <a class="header-anchor" href="#compile-time-magic" aria-hidden="true">#</a></h3><p>In the recent <a href="https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md" target="_blank" rel="noopener"><code>&lt;script setup&gt;</code> proposal</a> update, a new <a href="https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md#top-level-await" target="_blank" rel="noopener">compile-time magic</a> is introduced.</p><p>The way it works is to inject a script after each <code>await</code> statement for restoring the current instance state.</p><pre><code class="language-html"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#858585">&lt;</span><span style="color:#429988">script</span><span style="color:#dbd7ca"> </span><span style="color:#e0a569">setup</span><span style="color:#858585">&gt;</span></span>
<span class="line"><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">post</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">fetch</span><span style="color:#858585">(</span><span style="color:#c98a7d">`/api/post/1`</span><span style="color:#858585">).</span><span style="color:#a1b567">then</span><span style="color:#858585">((</span><span style="color:#b8a965">r</span><span style="color:#858585">)</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">r</span><span style="color:#858585">.</span><span style="color:#a1b567">json</span><span style="color:#858585">())</span></span>
<span class="line"><span style="color:#858585">&lt;/</span><span style="color:#429988">script</span><span style="color:#858585">&gt;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#8e8f8b">&lt;</span><span style="color:#2f8a89">script</span><span style="color:#393a34"> </span><span style="color:#b58451">setup</span><span style="color:#8e8f8b">&gt;</span></span>
<span class="line"><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">post</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#6c7834">fetch</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">`/api/post/1`</span><span style="color:#8e8f8b">).</span><span style="color:#6c7834">then</span><span style="color:#8e8f8b">((</span><span style="color:#8c862b">r</span><span style="color:#8e8f8b">)</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">r</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">json</span><span style="color:#8e8f8b">())</span></span>
<span class="line"><span style="color:#8e8f8b">&lt;/</span><span style="color:#2f8a89">script</span><span style="color:#8e8f8b">&gt;</span></span>
<span class="line"></span></code></pre></div></code></pre><pre><code class="language-js"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color:#121212"><code v-pre=""><span class="line"><span style="color:#4d9375">import</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">withAsyncContext</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">from</span><span style="color:#dbd7ca"> </span><span style="color:#c98a7d">'vue'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4d9375">export</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">default</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#cb7676">async</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">setup</span><span style="color:#858585">()</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#cb7676">let</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">__temp</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">__restore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#cb7676">const</span><span style="color:#dbd7ca"> </span><span style="color:#d4976c">post</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#858585">(([</span><span style="color:#b8a965">__temp</span><span style="color:#858585">,</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">__restore</span><span style="color:#858585">]</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#a1b567">withAsyncContext</span><span style="color:#858585">(()</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span></span>
<span class="line"><span style="color:#dbd7ca">        </span><span style="color:#a1b567">fetch</span><span style="color:#858585">(</span><span style="color:#c98a7d">`/api/post/1`</span><span style="color:#858585">).</span><span style="color:#a1b567">then</span><span style="color:#858585">((</span><span style="color:#b8a965">r</span><span style="color:#858585">)</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=&gt;</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">r</span><span style="color:#858585">.</span><span style="color:#a1b567">json</span><span style="color:#858585">())</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#858585">)),</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#858585">(</span><span style="color:#b8a965">__temp</span><span style="color:#dbd7ca"> </span><span style="color:#cb7676">=</span><span style="color:#dbd7ca"> </span><span style="color:#4d9375">await</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">__temp</span><span style="color:#858585">),</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#a1b567">__restore</span><span style="color:#858585">(),</span></span>
<span class="line"><span style="color:#dbd7ca">      </span><span style="color:#b8a965">__temp</span><span style="color:#858585">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// current instance context preserved</span></span>
<span class="line"><span style="color:#858585">    </span><span style="color:#758575">// e.g. onMounted() will still work.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#dbd7ca">    </span><span style="color:#4d9375">return</span><span style="color:#dbd7ca"> </span><span style="color:#858585">{</span><span style="color:#dbd7ca"> </span><span style="color:#b8a965">post</span><span style="color:#dbd7ca"> </span><span style="color:#858585">}</span></span>
<span class="line"><span style="color:#dbd7ca">  </span><span style="color:#858585">}</span></span>
<span class="line"><span style="color:#858585">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#fff"><code v-pre=""><span class="line"><span style="color:#1c6b48">import</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">withAsyncContext</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span><span style="color:#393a34"> </span><span style="color:#1c6b48">from</span><span style="color:#393a34"> </span><span style="color:#b56959">'vue'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1c6b48">export</span><span style="color:#393a34"> </span><span style="color:#1c6b48">default</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#ab5959">async</span><span style="color:#393a34"> </span><span style="color:#6c7834">setup</span><span style="color:#8e8f8b">()</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#ab5959">let</span><span style="color:#393a34"> </span><span style="color:#8c862b">__temp</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8c862b">__restore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#ab5959">const</span><span style="color:#393a34"> </span><span style="color:#a65e2b">post</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#8e8f8b">(([</span><span style="color:#8c862b">__temp</span><span style="color:#8e8f8b">,</span><span style="color:#393a34"> </span><span style="color:#8c862b">__restore</span><span style="color:#8e8f8b">]</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#6c7834">withAsyncContext</span><span style="color:#8e8f8b">(()</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span></span>
<span class="line"><span style="color:#393a34">        </span><span style="color:#6c7834">fetch</span><span style="color:#8e8f8b">(</span><span style="color:#b56959">`/api/post/1`</span><span style="color:#8e8f8b">).</span><span style="color:#6c7834">then</span><span style="color:#8e8f8b">((</span><span style="color:#8c862b">r</span><span style="color:#8e8f8b">)</span><span style="color:#393a34"> </span><span style="color:#ab5959">=&gt;</span><span style="color:#393a34"> </span><span style="color:#8c862b">r</span><span style="color:#8e8f8b">.</span><span style="color:#6c7834">json</span><span style="color:#8e8f8b">())</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#8e8f8b">)),</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#8e8f8b">(</span><span style="color:#8c862b">__temp</span><span style="color:#393a34"> </span><span style="color:#ab5959">=</span><span style="color:#393a34"> </span><span style="color:#1c6b48">await</span><span style="color:#393a34"> </span><span style="color:#8c862b">__temp</span><span style="color:#8e8f8b">),</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#6c7834">__restore</span><span style="color:#8e8f8b">(),</span></span>
<span class="line"><span style="color:#393a34">      </span><span style="color:#8c862b">__temp</span><span style="color:#8e8f8b">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// current instance context preserved</span></span>
<span class="line"><span style="color:#8e8f8b">    </span><span style="color:#a0ada0">// e.g. onMounted() will still work.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393a34">    </span><span style="color:#1c6b48">return</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">{</span><span style="color:#393a34"> </span><span style="color:#8c862b">post</span><span style="color:#393a34"> </span><span style="color:#8e8f8b">}</span></span>
<span class="line"><span style="color:#393a34">  </span><span style="color:#8e8f8b">}</span></span>
<span class="line"><span style="color:#8e8f8b">}</span></span>
<span class="line"></span></code></pre></div></code></pre><p>With it, the async functions will <strong>just work</strong> when using with <code>&lt;script setup&gt;</code>. The only shame is it does not work outside of <code>&lt;script setup&gt;</code>.</p></div><!--]--></article><div class="prose m-auto mt-8 mb-8"><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Fasync-with-composition-api%0A%0AI%20think..." target="_blank" op50="">comment on twitter</a><br><a href="/posts" class="font-mono no-underline opacity-50 hover:opacity-75">cd ..</a></div><!--]--><div class="mt-10 mb-6 prose m-auto opacity-50 flex"><span class="text-sm"><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="color:inherit">CC BY-NC-SA 4.0</a> 2021-PRESENT © Anthony Fu</span><div class="flex-auto"></div></div></main><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><link rel="stylesheet" href="/assets/index.e1648c97.css"></body></html>